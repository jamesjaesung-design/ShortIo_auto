<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Short.io Clickstream ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 2rem;
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            margin-bottom: 1.5rem;
            color: #667eea;
            text-align: center;
        }
        .config-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }
        input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .status {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 6px;
            font-weight: 600;
        }
        .status.active {
            background: #d4edda;
            color: #155724;
        }
        .status.inactive {
            background: #f8d7da;
            color: #721c24;
        }
        .data-section {
            margin-top: 2rem;
        }
        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .data-count {
            color: #667eea;
            font-weight: 600;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .url-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .ref-cell {
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #667eea;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }
        .auto-refresh-info {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— Short.io Clickstream ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h1>
        
        <div class="config-section">
            <div class="form-group">
                <label for="domainId">Domain ID:</label>
                <input type="text" id="domainId" placeholder="ë„ë©”ì¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
            </div>
            <div class="form-group">
                <label for="limit">ê°€ì ¸ì˜¬ í´ë¦­ ìˆ˜ (Limit):</label>
                <input type="number" id="limit" value="30" min="1" max="100" />
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="fetchClickstream()">ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
                <button class="btn-secondary" onclick="startAutoRefresh()">ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘</button>
                <button class="btn-danger" onclick="stopAutoRefresh()">ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€</button>
            </div>
            <div id="status" class="status inactive">ëŒ€ê¸° ì¤‘</div>
            <div class="auto-refresh-info" id="refreshInfo"></div>
        </div>

        <div class="data-section">
            <div class="data-header">
                <h2>í´ë¦­ ë°ì´í„°</h2>
                <div class="data-count" id="dataCount">0ê°œ í•­ëª©</div>
            </div>
            <div id="errorMessage"></div>
            <div id="loadingMessage" class="loading" style="display: none;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            <div id="dataTable"></div>
        </div>
    </div>

    <script>
        const API_KEY = 'pk_ZM3f2wHyUQi6x9VJ';
        const API_URL = 'https://api-v2.short.io/statistics/domain';
        let autoRefreshInterval = null;
        let lastRefreshTime = null;

        async function fetchClickstream() {
            const domainId = document.getElementById('domainId').value.trim();
            const limit = parseInt(document.getElementById('limit').value) || 30;
            
            if (!domainId) {
                showError('Domain IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const dataTable = document.getElementById('dataTable');
            const status = document.getElementById('status');

            loadingMessage.style.display = 'block';
            errorMessage.innerHTML = '';
            dataTable.innerHTML = '';

            try {
                const url = `${API_URL}/${domainId}/last_clicks`;
                const payload = {
                    limit: limit,
                    include: { human: true }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'accept': '*/*',
                        'content-type': 'application/json',
                        'authorization': API_KEY
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`API ì˜¤ë¥˜: ${response.status} - ${errorData}`);
                }

                const data = await response.json();
                lastRefreshTime = new Date();
                updateRefreshInfo();
                
                if (data && Array.isArray(data) && data.length > 0) {
                    displayData(data);
                    status.textContent = `âœ… ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${lastRefreshTime.toLocaleTimeString('ko-KR')}`;
                    status.className = 'status active';
                } else {
                    dataTable.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    status.textContent = 'âš ï¸ ë°ì´í„° ì—†ìŒ';
                    status.className = 'status inactive';
                }
            } catch (error) {
                console.error('Error:', error);
                showError(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                status.textContent = 'âŒ ì˜¤ë¥˜ ë°œìƒ';
                status.className = 'status inactive';
            } finally {
                loadingMessage.style.display = 'none';
            }
        }

        function displayData(clicks) {
            const dataTable = document.getElementById('dataTable');
            const dataCount = document.getElementById('dataCount');
            
            dataCount.textContent = `${clicks.length}ê°œ í•­ëª©`;

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ìˆœë²ˆ</th>
                            <th>URL</th>
                            <th>ë‚ ì§œ/ì‹œê°„ (dt)</th>
                            <th>ë ˆí¼ëŸ¬ (ref)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            clicks.forEach((click, index) => {
                const url = click.url || '-';
                const dt = click.dt ? new Date(click.dt).toLocaleString('ko-KR') : '-';
                const ref = click.ref || '-';

                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="url-cell" title="${url}">${url}</td>
                        <td>${dt}</td>
                        <td class="ref-cell" title="${ref}">${ref}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            dataTable.innerHTML = tableHTML;
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.innerHTML = `<div class="error">${message}</div>`;
        }

        function startAutoRefresh() {
            const domainId = document.getElementById('domainId').value.trim();
            if (!domainId) {
                showError('Domain IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (autoRefreshInterval) {
                stopAutoRefresh();
            }

            // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
            fetchClickstream();

            // 10ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
            autoRefreshInterval = setInterval(() => {
                fetchClickstream();
            }, 10000);

            const status = document.getElementById('status');
            status.textContent = 'ğŸ”„ ìë™ ìƒˆë¡œê³ ì¹¨ í™œì„±í™” (10ì´ˆ ê°„ê²©)';
            status.className = 'status active';
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            const status = document.getElementById('status');
            status.textContent = 'â¸ï¸ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€ë¨';
            status.className = 'status inactive';
        }

        function updateRefreshInfo() {
            const refreshInfo = document.getElementById('refreshInfo');
            if (lastRefreshTime) {
                refreshInfo.textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${lastRefreshTime.toLocaleString('ko-KR')}`;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ìƒíƒœ í‘œì‹œ
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
    </script>
</body>
</html>
